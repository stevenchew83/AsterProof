{% extends 'layouts/vertical.html' %}
{% load static %}

{% block title %}Problem Set Import{% endblock title %}

{% block page_content %}
<div class="container-fluid">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
    <h2 class="mb-0">Problem Set Import</h2>
    <a href="{% static 'data/problem_import_sample.csv' %}" class="btn btn-outline-primary" download>Download sample CSV</a>
  </div>
  <p class="text-muted">Upload a CSV file to create entries in the Problem Submission queue. If your source is <code>.xlsx</code>, export it as CSV (UTF-8) first.</p>

  <div class="card mb-3">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}
        <div class="col-md-8">
          <label class="form-label">CSV file</label>
          <input type="file" class="form-control" name="problem_csv" accept=".csv" required>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Import to Submission Queue</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="mb-2">CSV columns</h5>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Column</th>
              <th>Required</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr><td><code>title</code></td><td>Yes</td><td>Problem title</td></tr>
            <tr><td><code>statement</code></td><td>Yes</td><td>Problem statement text</td></tr>
            <tr><td><code>statement_format</code></td><td>No</td><td><code>plain</code>, <code>latex</code>, or <code>markdown_tex</code> (defaults to <code>plain</code>)</td></tr>
            <tr><td><code>source_reference</code></td><td>No</td><td>Source URL (must start with <code>http://</code> or <code>https://</code>)</td></tr>
            <tr><td><code>proposed_tags</code></td><td>No</td><td>Comma-separated tags</td></tr>
            <tr><td><code>proposed_difficulty</code></td><td>No</td><td>Difficulty from 0 to 60 (must be integer, defaults to 3)</td></tr>
            <tr><td><code>contest_short_code</code></td><td>No</td><td>If provided, links/creates contest by short code</td></tr>
            <tr><td><code>contest_name</code></td><td>No</td><td>Used only when creating a new contest</td></tr>
            <tr><td><code>contest_year</code></td><td>No</td><td>Used only when creating a new contest</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% if created_count or skipped_count %}
  <div class="card">
    <div class="card-body">
      <h5 class="mb-2">Last Import Summary</h5>
      <p class="mb-3">Created: <strong>{{ created_count }}</strong> | Skipped: <strong>{{ skipped_count }}</strong></p>

      {% if preview_rows %}
      <h6>Imported rows (first {{ preview_rows|length }})</h6>
      <div class="table-responsive mb-3">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Format</th>
              <th>Difficulty</th>
              <th>Contest</th>
            </tr>
          </thead>
          <tbody>
            {% for row in preview_rows %}
            <tr>
              <td>{{ row.id }}</td>
              <td>{{ row.title }}</td>
              <td>{{ row.statement_format }}</td>
              <td>{{ row.difficulty }}</td>
              <td>{{ row.contest }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      {% if skipped_rows %}
      <h6>Skipped rows</h6>
      <ul class="mb-0">
        {% for item in skipped_rows %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock page_content %}

{% block extra_javascript %}
<script>
  (function () {
    const fileInput = document.querySelector('input[name="problem_csv"]');
    if (!fileInput) {
      return;
    }

    const previewCard = document.createElement("div");
    previewCard.className = "card mt-3 d-none";
    previewCard.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
          <h5 class="mb-0">Uploaded File Preview</h5>
          <small class="text-muted" data-preview-meta></small>
        </div>
        <p class="text-muted mb-2">Showing first rows from the selected CSV before import.</p>
        <div class="table-responsive">
          <table class="table table-striped table-sm mb-0">
            <thead><tr data-preview-head></tr></thead>
            <tbody data-preview-body></tbody>
          </table>
        </div>
      </div>
    `;
    document.querySelector(".container-fluid")?.appendChild(previewCard);

    const previewHead = previewCard.querySelector("[data-preview-head]");
    const previewBody = previewCard.querySelector("[data-preview-body]");
    const previewMeta = previewCard.querySelector("[data-preview-meta]");

    function splitCsvLine(line) {
      const cells = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === '"') {
          const next = line[i + 1];
          if (inQuotes && next === '"') {
            current += '"';
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }
        if (char === "," && !inQuotes) {
          cells.push(current.trim());
          current = "";
          continue;
        }
        current += char;
      }
      cells.push(current.trim());
      return cells;
    }

    function resetPreview() {
      previewHead.innerHTML = "";
      previewBody.innerHTML = "";
      previewMeta.textContent = "";
      previewCard.classList.add("d-none");
    }

    function renderPreview(text, fileName) {
      const lines = text
        .split(/\r?\n/)
        .map((line) => line.trimEnd())
        .filter((line) => line.length > 0);
      if (!lines.length) {
        resetPreview();
        return;
      }

      const headers = splitCsvLine(lines[0]).slice(0, 8);
      const maxRows = 8;
      const dataRows = lines.slice(1, 1 + maxRows).map((line) => splitCsvLine(line).slice(0, 8));

      previewHead.innerHTML = headers.map((value) => `<th>${value || "-"}</th>`).join("");
      previewBody.innerHTML = dataRows
        .map(
          (row) =>
            `<tr>${headers
              .map((_, index) => `<td>${row[index] || ""}</td>`)
              .join("")}</tr>`,
        )
        .join("");
      previewMeta.textContent = `${fileName} â€¢ ${Math.max(lines.length - 1, 0)} data row(s)`;
      previewCard.classList.remove("d-none");
    }

    fileInput.addEventListener("change", function () {
      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        resetPreview();
        return;
      }
      const reader = new FileReader();
      reader.onload = function (event) {
        const text = String(event.target?.result || "");
        renderPreview(text, file.name);
      };
      reader.onerror = resetPreview;
      reader.readAsText(file, "utf-8");
    });
  })();
</script>
{% endblock extra_javascript %}
